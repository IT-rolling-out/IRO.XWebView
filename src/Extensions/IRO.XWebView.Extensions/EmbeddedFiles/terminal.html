<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>terminal.js test</title>
    <script>
        /*! terminal.js v2.0 | (c) 2014 Erik Österberg | https://github.com/eosterberg/terminaljs */

        String.prototype.replaceAll = function (search, replacement) {
            var target = this;
            return target.split(search).join(replacement);
        };

        String.prototype.insert = function (index, string) {
            if (index === this.length) {
                return this + string;
            }
            if (index > 0) {
                return this.substring(0, index) + string + this.substr(index);
            }
            return string + this;
        };

        var terminalCore = {
            isCursorVisibleNow: false,
            enterCharacter: "Ǆ",
            cursorPosition: 0,
            prevStrLength: 0,

            replaceSubstrings: function (source, search, replacement) {
                return source.split(search).join(replacement);
            },

            moveCaretDown: function (str, index) {
                console.log(str);
                while (index < str.length) {
                    index++;
                    //console.log(index + " = " + str[index])
                    if (str[index] === terminalCore.enterCharacter) {
                        //console.log(index + 1)
                        return index;
                    }
                }
                return str.length;
            },

            moveCaretUp: function (str, index) {
                console.log(str);
                while (index >= 0) {
                    index--;
                    //console.log(index + " = " + str[index])
                    if (str[index] === terminalCore.enterCharacter) {
                        //console.log(index + 1)
                        return index;
                    }
                }
                return 0;
            },

            escapeToHtml: function (str) {
                var replaceSubstrings = terminalCore.replaceSubstrings;
                var res = str;

                res = replaceSubstrings(res, /&/g, "&amp;");
                res = replaceSubstrings(res, /</g, "&lt;");
                res = replaceSubstrings(res, />/g, "&gt;");
                res = replaceSubstrings(res, /"/g, "&quot;");
                res = replaceSubstrings(res, /'/g, "&#039;");
                res = replaceSubstrings(res, '\n', '<br>');
                res = replaceSubstrings(res, terminalCore.enterCharacter, '<br>');
                res = replaceSubstrings(res, '\r', '');
                res = replaceSubstrings(res, '\t', '&ensp;&ensp;');
                res = replaceSubstrings(res, '  ', '&ensp;');
                return res;

            },

            escapeSpecialCharacters: function (str) {
                var replaceSubstrings = terminalCore.replaceSubstrings;
                var res = str;

                res = replaceSubstrings(res, terminalCore.enterCharacter, '\n');
                return res;

            }
        }

        var Terminal = (function () {
            window.TerminalTextColor = "#ffffff";
            // PROMPT_TYPE
            var PROMPT_INPUT = 1, PROMPT_PASSWORD = 2, PROMPT_CONFIRM = 3

            function updateTerminalInput(inputField, terminalObj) {
                var charToSet = terminalCore.isCursorVisibleNow ? " " : "|";
                terminalCore.isCursorVisibleNow = !terminalCore.isCursorVisibleNow;
                var textToPrint = inputField.value.insert(inputField.selectionStart, charToSet);
                textToPrint = terminalCore.escapeToHtml(textToPrint);
                terminalObj._inputLine.innerHTML = textToPrint;
            }

            var fireCursorInterval = function (inputField, terminalObj) {
                setTimeout(function () {
                    updateTerminalInput(inputField, terminalObj);
                    if (terminalObj._currentInputField != inputField) {
                        return;
                    }
                    fireCursorInterval(inputField, terminalObj)
                }, 500)
            }

            var firstPrompt = true;
            promptInput = function (terminalObj, message, PROMPT_TYPE, callback) {
                var shouldDisplayInput = (PROMPT_TYPE === PROMPT_INPUT)
                var inputField = document.createElement('input')

                inputField.style.position = 'absolute'
                inputField.style.zIndex = '-100'
                inputField.style.outline = 'none'
                inputField.style.border = 'none'
                inputField.style.opacity = '0'
                inputField.style.fontSize = '0.2em'

                terminalObj._currentInputField = inputField;
                terminalObj._inputLine.textContent = ''
                terminalObj._input.style.display = 'block'
                terminalObj.html.appendChild(inputField)
                fireCursorInterval(inputField, terminalObj)

                if (message.length) terminalObj.print(PROMPT_TYPE === PROMPT_CONFIRM ? message + ' (y/n)' : message)

                inputField.onblur = function () {
                    //terminalObj._cursor.style.display = 'none'
                }

                inputField.onfocus = function () {
                    //inputField.value = terminalObj._inputLine.textContent
                    //terminalObj._cursor.style.display = 'inline'
                }

                terminalObj.html.onclick = function () {
                    inputField.focus()
                }

                inputField.onkeydown = function (e) {
                    var newSelection = false;
                    if (e.which === 38) {
                        newSelection = terminalCore.moveCaretUp(inputField.value, inputField.selectionStart);
                    }
                    else if (e.which === 40) {
                        newSelection = terminalCore.moveCaretDown(inputField.value, inputField.selectionStart);
                    } else if (e.which === 37) {
                        newSelection = inputField.selectionStart - 1;
                        if (newSelection < 0)
                            newSelection = 0;
                    } else if (e.which === 39) {
                        newSelection = inputField.selectionStart + 1;
                        if (newSelection > inputField.value.length)
                            newSelection = inputField.value.length;
                    }

                    setTimeout(function () {
                        if (newSelection) {
                            inputField.selectionStart = newSelection;
                            inputField.selectionEnd = newSelection;
                        }

                        // if (e.which === 37 || e.which === 39 || e.which === 38 || e.which === 40 || e.which === 9) {
                        //     e.preventDefault()
                        // }

                        if (e.which === 13 && e.shiftKey) {
                            inputField.value = inputField.value.insert(inputField.selectionStart, terminalCore.enterCharacter);
                        }

                        updateTerminalInput(inputField, terminalObj);

                        //terminalObj._inputLine.innerHTML = terminalCore.escapeToHtml(inputField.value)
                        window["INP"] = inputField;

                        // console.log("Val1 = " + inputField.value);
                        // console.log("Val1 = " + terminalCore.escapeToHtml(inputField.value));
                        // console.log(e);
                    }, 1)


                }
                inputField.onkeyup = function (e) {
                    if (PROMPT_TYPE === PROMPT_CONFIRM || (e.which === 13 && !e.shiftKey)) {
                        terminalObj._input.style.display = 'none'
                        var inputValue = terminalCore.escapeSpecialCharacters(inputField.value)
                        if (shouldDisplayInput)
                            terminalObj.print(inputValue)
                        terminalObj.html.removeChild(inputField)
                        if (typeof (callback) === 'function') {
                            if (PROMPT_TYPE === PROMPT_CONFIRM) {
                                callback(inputValue.toUpperCase()[0] === 'Y' ? true : false)
                            }
                            else {
                                callback(inputValue)
                            }
                        }
                        inputField.value = ""
                    }
                }
                if (firstPrompt) {
                    firstPrompt = false
                    setTimeout(function () { inputField.focus() }, 50)
                } else {
                    inputField.focus()
                }
            }

            var terminalBeep

            var TerminalConstructor = function (id) {
                if (!terminalBeep) {
                    terminalBeep = document.createElement('audio')
                    var source = '<source src="http://www.erikosterberg.com/terminaljs/beep.'
                    terminalBeep.innerHTML = source + 'mp3" type="audio/mpeg">' + source + 'ogg" type="audio/ogg">'
                    terminalBeep.volume = 0.05
                }

                this.html = document.createElement('div')
                this.html.className = 'Terminal'
                if (typeof (id) === 'string') { this.html.id = id }

                this._innerWindow = document.createElement('div')
                this._output = document.createElement('p')
                this._inputLine = document.createElement('span') //the span element where the users input is put
                //this._cursor = document.createElement('span')
                this._input = document.createElement('p') //the full element administering the user input, including cursor

                this._shouldBlinkCursor = true

                this.beep = function () {
                    terminalBeep.load()
                    terminalBeep.play()
                }

                this.print = function (message) {

                    var newLine = document.createElement('div')
                    newLine.innerHTML = terminalCore.escapeToHtml(message)
                    newLine.style.color = window.TerminalTextColor;
                    this._output.appendChild(newLine)
                }

                this.input = function (message, callback) {
                    promptInput(this, message, PROMPT_INPUT, callback)
                }

                this.password = function (message, callback) {
                    promptInput(this, message, PROMPT_PASSWORD, callback)
                }

                this.confirm = function (message, callback) {
                    promptInput(this, message, PROMPT_CONFIRM, callback)
                }

                this.clear = function () {
                    this._output.innerHTML = ''
                }

                this.sleep = function (milliseconds, callback) {
                    setTimeout(callback, milliseconds)
                }

                this.setTextSize = function (size) {
                    this._output.style.fontSize = size
                    this._input.style.fontSize = size
                }

                this.setTextColor = function (col) {
                    this.html.style.color = col
                    //this._cursor.style.background = col
                }

                this.setBackgroundColor = function (col) {
                    this.html.style.background = col
                }

                this.setWidth = function (width) {
                    this.html.style.width = width
                }

                this.setHeight = function (height) {
                    this.html.style.height = height
                }

                this.blinkingCursor = function (bool) {
                    bool = bool.toString().toUpperCase()
                    this._shouldBlinkCursor = (bool === 'TRUE' || bool === '1' || bool === 'YES')
                }

                this._input.appendChild(this._inputLine)
                //this._input.appendChild(this._cursor)
                this._innerWindow.appendChild(this._output)
                this._innerWindow.appendChild(this._input)
                this.html.appendChild(this._innerWindow)

                this.setBackgroundColor('black')
                this.setTextColor('white')
                this.setTextSize('1em')
                this.setWidth('100%')
                this.setHeight('100%')

                this.html.style.fontFamily = 'Monaco, Courier'
                this.html.style.margin = '0'
                this._innerWindow.style.padding = '10px'
                this._input.style.margin = '0'
                this._output.style.margin = '0'
                // this._cursor.style.background = 'white'
                // this._cursor.innerHTML = 'C' //put something in the cursor..
                // this._cursor.style.display = 'none' //then hide it
                this._input.style.display = 'none'
            }

            return TerminalConstructor
        }())
    </script>
    <style>
        body {
            margin: 0px;
            font-weight: bold;
        }

        .Terminal {
            min-height: 100vh;
            padding-bottom: 100px;
        }
    </style>
</head>

<body>
    <script>
        window.Term = new Terminal();
        document.body.appendChild(Term.html);

        function ReadLine(term) {
            return new Promise(function (resolve, reject) {
                term.input("", resolve);
            });
        }

        function SetTextColor(color) {
            window.TerminalTextColor = color;
        }

                // (async function () {
                // 	while (true) {
                // 		await ReadLine();
                // 	}
                // })();
    </script>

</body>

</html>